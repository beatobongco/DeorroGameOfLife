<!DOCTYPE html>
<html>
<head>
  <title>Deorro's Game of Life</title>
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/6.0.0/normalize.min.css">
  <style type="text/css">
    body {
      overflow: hidden;
      margin: 0;
      background-color: #000;
      color: #fff;
    }
    canvas {
      cursor: pointer;
      display: block;
      margin: 100px auto;
    }
  </style>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.5.8/p5.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.5.8/addons/p5.sound.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min.js"></script>
  <script type="text/javascript" src="static/js/seed.js"></script>
</head>
<body>
<script type="text/javascript">
  var song, analyzer, lifeArray
  var firstRun = true
  var pixelSize = 10
  var bins = 0
  var aliveColor = '#ff0000'
  var canvasWidth = 720
  var canvasHeight = 300
  var bgColor = '#000'
  var soundbarColor = '#fff'
  var fps = 30

  function initializeLifeArray() {
    //creates initial lifeArray
    lifeArray = []
    for (var y = 0; y < canvasHeight; y+=pixelSize) {
      var _array = []
      for (var x = 0; x < canvasWidth; x+=pixelSize) {
        var int8 = new Int8Array(2)
        // [isAlive, isSoundbar]
        _array.push(int8)
      }
      lifeArray.push(_array)
    }
  }

  function checkNeighbors(x, y) {
    // returns number of alive
    alive = 0
    neighbors = [[x+1, y], [x-1, y], [x, y+1], [x, y-1],
                 [x+1, y+1], [x-1, y-1], [x+1, y-1], [x-1, y+1]]

    for (var i = 0; i < neighbors.length; i++) {
      var _x = neighbors[i][0]
      var _y = neighbors[i][1]

      // wrap around x only
      if (_x < 0) {
        _x = lifeArray[0].length - 1
      } else if (_x >= lifeArray[0].length) {
        _x = 0
      }

      if (_y > 0 && _y < lifeArray.length && lifeArray[_y][_x][0]) {
        alive++
      }
    }
    return alive
  }

  function reset() {
    initializeLifeArray()
    //seedLife()
    generateGalaxy(0, 5)
  }

  function preload() {
    song = loadSound('static/audio/deorro.mp3')
  }

  function setup() {
    background(0)
    // get bins
    var n = 1
    while (bins < canvasWidth / pixelSize) {
      bins = 2**n
      n++
    }
    fft = new p5.FFT(0.8, bins)
    createCanvas(canvasWidth, canvasHeight)
    stroke(bgColor)
    frameRate(fps)
    song.onended(generateEnding)
    reset()
    noLoop()
  }

  function drawWaveform() {
    var waveform = fft.waveform()
    var bottomline = lifeArray.length - 1
    var maxAmp = Math.round(lifeArray[bottomline].length / 4)

    for (var i = 0; i < lifeArray[bottomline].length; i++) {
      var amplitude = waveform[i] * maxAmp

      if (amplitude < 0) {
        continue
      }

      if (waveform[i] > .9) {
        // generate some cool stuff here
        generateUpGlider(i, bottomline - j - 3)
      }

      for (var j = 0; j <= maxAmp; j++) {
        if (amplitude >= j) {
          lifeArray[bottomline - j][i][1] = true
          lifeArray[bottomline - j][i][0] = true
        } else if (lifeArray[bottomline - j][i][1]) {
          // leave normal cells alone, deactivate soundbars
          lifeArray[bottomline - j][i][1] = false
          lifeArray[bottomline - j][i][0] = false
        }
      }
    }
  }

  function draw() {
    drawWaveform()

    if (firstRun) {
      firstRun = false
      drawGeneration()
      return
    }

    // check state change
    _lifeArray = _.cloneDeep(lifeArray)

    for (var y = 0; y < lifeArray.length; y++) {
      for (var x = 0; x < lifeArray[y].length; x++) {
        var cell = lifeArray[y][x]
        //skip soundbars
        if (cell[1]) {
          continue
        }
        var liveNeighbors = checkNeighbors(x, y)
        if (cell[0]) {
          if (!(liveNeighbors === 2 || liveNeighbors === 3)) {
            _lifeArray[y][x][0] = false
          }
        } else {
          if (liveNeighbors === 3) {
            _lifeArray[y][x][0] = true
          }
        }
      }
    }

    lifeArray = _lifeArray
    drawGeneration()
  }

  function drawGeneration() {
    for (var y = 0; y < lifeArray.length; y++) {
      for (var x = 0; x < lifeArray[y].length; x++) {
        var cell = lifeArray[y][x]
        if (cell[0]) {
          fill(cell[1] ? soundbarColor : aliveColor)
        } else {
          fill(bgColor)
        }
        rect(x * pixelSize, y * pixelSize, pixelSize, pixelSize)
      }
    }
  }

  function togglePlay() {
    if (song.isPlaying() ) {
      song.pause()
      noLoop()
    } else {
      song.play()
      loop()
    }
  }

  function mousePressed() {
    togglePlay()
  }

  function keyPressed() {
    if (keyCode === 32) {
      togglePlay()
    }
  }
</script>
</body>
</html>
